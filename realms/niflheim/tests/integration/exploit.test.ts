/**
 * Niflheim Integration Test: Exploit Path
 * 
 * Tests the A10:2025 Exceptional Conditions vulnerability.
 * This test verifies that the intentional fail-open behavior works as designed.
 */

describe('Niflheim Exploit Path', () => {
  const BASE_URL = process.env.TEST_BASE_URL || 'http://localhost:8080/realms/niflheim';

  describe('A10:2025 - Exceptional Conditions Vulnerability', () => {
    it('should reveal flag when given negative pressure value', async () => {
      const response = await fetch(`${BASE_URL}/api/pressure`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pressure: -9999 }),
      });

      // Should return error status
      expect(response.status).toBe(500);

      const data = await response.json() as { error?: string; [key: string]: unknown };
      
      // Error message should contain flag
      expect(data.error).toBeDefined();
      expect(data.error).toContain('YGGDRASIL{');
      expect(data.error).toContain('NIFLHEIM');
    });

    it('should reveal flag when given extremely high pressure value', async () => {
      const response = await fetch(`${BASE_URL}/api/pressure`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pressure: 999999 }),
      });

      expect(response.status).toBe(500);
      const data = await response.json() as { error?: string; [key: string]: unknown };
      
      expect(data.error).toContain('YGGDRASIL{NIFLHEIM:');
    });

    it('should reveal flag when given NaN value', async () => {
      const response = await fetch(`${BASE_URL}/api/pressure`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pressure: 'not-a-number' }),
      });

      expect(response.status).toBe(500);
      const data = await response.json() as { error?: string; [key: string]: unknown };
      
      expect(data.error).toContain('YGGDRASIL{');
    });

    it('should extract valid flag format from error', async () => {
      const response = await fetch(`${BASE_URL}/api/pressure`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pressure: -1 }),
      });

      const data = await response.json() as { error?: string; [key: string]: unknown };
      const flagMatch = data.error.match(/YGGDRASIL\{[^}]+\}/);
      
      expect(flagMatch).not.toBeNull();
      
      if (flagMatch) {
        const flag = flagMatch[0];
        // Validate flag format: YGGDRASIL{NIFLHEIM:UUID}
        expect(flag).toMatch(/^YGGDRASIL\{NIFLHEIM:[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}\}$/i);
      }
    });

    it('should include emergency override message in error', async () => {
      const response = await fetch(`${BASE_URL}/api/pressure`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pressure: -5000 }),
      });

      const data = await response.json() as { error?: string; [key: string]: unknown };
      
      expect(data.error).toContain('EMERGENCY OVERRIDE');
      expect(data.error).toContain('CRITICAL ERROR');
    });
  });

  describe('Normal Operation (Non-Exploit)', () => {
    it('should handle valid pressure without errors', async () => {
      const response = await fetch(`${BASE_URL}/api/pressure`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pressure: 50 }),
      });

      expect(response.status).toBe(200);
      const data = await response.json() as { error?: string; [key: string]: unknown };
      
      expect(data.message).toBeDefined();
      expect(data.state).toBeDefined();
      expect(data.error).toBeUndefined();
    });

    it('should fetch system status successfully', async () => {
      const response = await fetch(`${BASE_URL}/api/status`);
      
      expect(response.status).toBe(200);
      const data = await response.json() as { error?: string; [key: string]: unknown };
      
      expect(data.currentPressure).toBeDefined();
      expect(data.doorStatus).toBeDefined();
    });
  });

  describe('Network Isolation', () => {
    it('should not be accessible via direct port 3000', async () => {
      // Attempt to access realm directly (should fail due to Docker network isolation)
      try {
        await fetch('http://niflheim:3000/health', {
          signal: AbortSignal.timeout(2000),
        });
        // If we get here, isolation is broken
        fail('Realm should not be accessible via direct port');
      } catch (error) {
        // Expected: connection refused or timeout
        expect(error).toBeDefined();
      }
    });
  });
});
